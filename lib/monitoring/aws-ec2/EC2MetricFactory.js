"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EC2MetricFactory = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const common_1 = require("../../common");
const EC2Namespace = "AWS/EC2";
/**
 * Creates a single metric for the whole ASG.
 */
class AutoScalingGroupStrategy {
    constructor(autoScalingGroup) {
        this.autoScalingGroup = autoScalingGroup;
    }
    createMetrics(metricFactory, metricName, statistic) {
        return [
            metricFactory.createMetric(metricName, statistic, undefined, resolveDimensions(this.autoScalingGroup, undefined), undefined, EC2Namespace),
        ];
    }
}
/**
 * Creates multiple metrics (one for each instance) with an optional ASG filter.
 */
class SelectedInstancesStrategy {
    constructor(instanceIds, autoScalingGroup) {
        this.instanceIds = instanceIds;
        this.autoScalingGroup = autoScalingGroup;
    }
    createMetrics(metricFactory, metricName, statistic) {
        return this.instanceIds.map((instanceId) => {
            return metricFactory.createMetric(metricName, statistic, `${metricName} (${instanceId})`, resolveDimensions(this.autoScalingGroup, instanceId), undefined, EC2Namespace);
        });
    }
}
/**
 * Creates a single metric search expression for all instances.
 */
class AllInstancesStrategy {
    createMetrics(metricFactory, metricName, statistic) {
        return [
            metricFactory.createMetricSearch(`MetricName="${metricName}"`, { InstanceId: undefined }, statistic, EC2Namespace),
        ];
    }
}
function resolveDimensions(autoScalingGroup, instanceId) {
    const dimensions = {};
    if (autoScalingGroup) {
        dimensions.AutoScalingGroupName = autoScalingGroup.autoScalingGroupName;
    }
    if (instanceId) {
        dimensions.InstanceId = instanceId;
    }
    return dimensions;
}
function resolveStrategy(props) {
    if (props.instanceIds) {
        // instance filter + optional ASG
        return new SelectedInstancesStrategy(props.instanceIds, props.autoScalingGroup);
    }
    else if (props.autoScalingGroup) {
        // ASG only
        return new AutoScalingGroupStrategy(props.autoScalingGroup);
    }
    else {
        // all instances
        return new AllInstancesStrategy();
    }
}
class EC2MetricFactory {
    constructor(metricFactory, props) {
        this.metricFactory = metricFactory;
        this.strategy = resolveStrategy(props);
    }
    /**
     * The percentage of allocated EC2 compute units that are currently in use on the instance.
     * This metric identifies the processing power required to run an application on a selected instance.
     * Depending on the instance type, tools in your operating system can show a lower percentage than
     * CloudWatch when the instance is not allocated a full processor core.
     */
    metricAverageCpuUtilisationPercent() {
        return this.createMetrics("CPUUtilization", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * Bytes read from all instance store volumes available to the instance.
     * This metric is used to determine the volume of the data the application reads from the hard disk of the instance.
     * This can be used to determine the speed of the application.
     */
    metricAverageDiskReadBytes() {
        return this.createDiskMetrics("ReadBytes", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * Bytes written to all instance store volumes available to the instance.
     * This metric is used to determine the volume of the data the application writes onto the hard disk of the instance.
     * This can be used to determine the speed of the application.
     */
    metricAverageDiskWriteBytes() {
        return this.createDiskMetrics("WriteBytes", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * Completed read operations from all instance store volumes available to the instance in a specified period of time.
     */
    metricAverageDiskReadOps() {
        return this.createDiskMetrics("ReadOps", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * Completed write operations to all instance store volumes available to the instance in a specified period of time.
     */
    metricAverageDiskWriteOps() {
        return this.createDiskMetrics("WriteOps", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * The number of bytes received on all network interfaces by the instance.
     * This metric identifies the volume of incoming network traffic to a single instance.
     */
    metricAverageNetworkInRateBytes() {
        return this.createMetrics("NetworkIn", common_1.MetricStatistic.AVERAGE);
    }
    /**
     * The number of bytes sent out on all network interfaces by the instance.
     * This metric identifies the volume of outgoing network traffic from a single instance.
     */
    metricAverageNetworkOutRateBytes() {
        return this.createMetrics("NetworkOut", common_1.MetricStatistic.AVERAGE);
    }
    createDiskMetrics(metricName, statistic) {
        const classicMetrics = this.strategy.createMetrics(this.metricFactory, `Disk${metricName}`, statistic);
        const ebsMetrics = this.strategy.createMetrics(this.metricFactory, `EBS${metricName}`, statistic);
        return classicMetrics.map((classic, i) => {
            const ebs = ebsMetrics[i];
            const usingMetrics = {};
            const classicId = `${metricName.toLowerCase()}_classic_${i}`;
            const ebsId = `${metricName.toLowerCase()}_ebs_${i}`;
            usingMetrics[classicId] = classic;
            usingMetrics[ebsId] = ebs;
            return this.metricFactory.createMetricMath(`AVG(REMOVE_EMPTY([${classicId}, ${ebsId}]))`, usingMetrics, `Disk${metricName}`);
        });
    }
    createMetrics(metricName, statistic) {
        return this.strategy.createMetrics(this.metricFactory, metricName, statistic);
    }
}
exports.EC2MetricFactory = EC2MetricFactory;
_a = JSII_RTTI_SYMBOL_1;
EC2MetricFactory[_a] = { fqn: "cdk-monitoring-constructs.EC2MetricFactory", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRUMyTWV0cmljRmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkVDMk1ldHJpY0ZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSx5Q0FBOEQ7QUFFOUQsTUFBTSxZQUFZLEdBQUcsU0FBUyxDQUFDO0FBVS9COztHQUVHO0FBQ0gsTUFBTSx3QkFBd0I7SUFHNUIsWUFBWSxnQkFBbUM7UUFDN0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0lBQzNDLENBQUM7SUFFRCxhQUFhLENBQ1gsYUFBNEIsRUFDNUIsVUFBa0IsRUFDbEIsU0FBMEI7UUFFMUIsT0FBTztZQUNMLGFBQWEsQ0FBQyxZQUFZLENBQ3hCLFVBQVUsRUFDVixTQUFTLEVBQ1QsU0FBUyxFQUNULGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLENBQUMsRUFDbkQsU0FBUyxFQUNULFlBQVksQ0FDYjtTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFFRDs7R0FFRztBQUNILE1BQU0seUJBQXlCO0lBSTdCLFlBQVksV0FBcUIsRUFBRSxnQkFBb0M7UUFDckUsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0lBQzNDLENBQUM7SUFFRCxhQUFhLENBQ1gsYUFBNEIsRUFDNUIsVUFBa0IsRUFDbEIsU0FBMEI7UUFFMUIsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ3pDLE9BQU8sYUFBYSxDQUFDLFlBQVksQ0FDL0IsVUFBVSxFQUNWLFNBQVMsRUFDVCxHQUFHLFVBQVUsS0FBSyxVQUFVLEdBQUcsRUFDL0IsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxFQUNwRCxTQUFTLEVBQ1QsWUFBWSxDQUNiLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNM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QUFDO1FBQ0YsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQzVDLElBQUksQ0FBQyxhQUFhLEVBQ2xCLE1BQU0sVUFBVSxFQUFFLEVBQ2xCLFNBQVMsQ0FDVixDQUFDO1FBRUYsT0FBTyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3ZDLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQixNQUFNLFlBQVksR0FBNEIsRUFBRSxDQUFDO1lBQ2pELE1BQU0sU0FBUyxHQUFHLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQzdELE1BQU0sS0FBSyxHQUFHLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ3JELFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDbEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUMxQixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQ3hDLHFCQUFxQixTQUFTLEtBQUssS0FBSyxLQUFLLEVBQzdDLFlBQVksRUFDWixPQUFPLFVBQVUsRUFBRSxDQUNwQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sYUFBYSxDQUFDLFVBQWtCLEVBQUUsU0FBMEI7UUFDbEUsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FDaEMsSUFBSSxDQUFDLGFBQWEsRUFDbEIsVUFBVSxFQUNWLFNBQVMsQ0FDVixDQUFDO0lBQ0osQ0FBQzs7QUFwR0gsNENBcUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUF1dG9TY2FsaW5nR3JvdXAgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWF1dG9zY2FsaW5nXCI7XG5pbXBvcnQgeyBEaW1lbnNpb25zTWFwLCBJTWV0cmljIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jbG91ZHdhdGNoXCI7XG5cbmltcG9ydCB7IE1ldHJpY0ZhY3RvcnksIE1ldHJpY1N0YXRpc3RpYyB9IGZyb20gXCIuLi8uLi9jb21tb25cIjtcblxuY29uc3QgRUMyTmFtZXNwYWNlID0gXCJBV1MvRUMyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVDMk1ldHJpY0ZhY3RvcnlTdHJhdGVneSB7XG4gIGNyZWF0ZU1ldHJpY3MoXG4gICAgbWV0cmljRmFjdG9yeTogTWV0cmljRmFjdG9yeSxcbiAgICBtZXRyaWNOYW1lOiBzdHJpbmcsXG4gICAgc3RhdGlzdGljOiBNZXRyaWNTdGF0aXN0aWNcbiAgKTogSU1ldHJpY1tdO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBzaW5nbGUgbWV0cmljIGZvciB0aGUgd2hvbGUgQVNHLlxuICovXG5jbGFzcyBBdXRvU2NhbGluZ0dyb3VwU3RyYXRlZ3kgaW1wbGVtZW50cyBJRUMyTWV0cmljRmFjdG9yeVN0cmF0ZWd5IHtcbiAgcHJvdGVjdGVkIGF1dG9TY2FsaW5nR3JvdXA6IElBdXRvU2NhbGluZ0dyb3VwO1xuXG4gIGNvbnN0cnVjdG9yKGF1dG9TY2FsaW5nR3JvdXA6IElBdXRvU2NhbGluZ0dyb3VwKSB7XG4gICAgdGhpcy5hdXRvU2NhbGluZ0dyb3VwID0gYXV0b1NjYWxpbmdHcm91cDtcbiAgfVxuXG4gIGNyZWF0ZU1ldHJpY3MoXG4gICAgbWV0cmljRmFjdG9yeTogTWV0cmljRmFjdG9yeSxcbiAgICBtZXRyaWNOYW1lOiBzdHJpbmcsXG4gICAgc3RhdGlzdGljOiBNZXRyaWNTdGF0aXN0aWNcbiAgKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIG1ldHJpY0ZhY3RvcnkuY3JlYXRlTWV0cmljKFxuICAgICAgICBtZXRyaWNOYW1lLFxuICAgICAgICBzdGF0aXN0aWMsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgcmVzb2x2ZURpbWVuc2lvbnModGhpcy5hdXRvU2NhbGluZ0dyb3VwLCB1bmRlZmluZWQpLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIEVDMk5hbWVzcGFjZVxuICAgICAgKSxcbiAgICBdO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlcyBtdWx0aXBsZSBtZXRyaWNzIChvbmUgZm9yIGVhY2ggaW5zdGFuY2UpIHdpdGggYW4gb3B0aW9uYWwgQVNHIGZpbHRlci5cbiAqL1xuY2xhc3MgU2VsZWN0ZWRJbnN0YW5jZXNTdHJhdGVneSBpbXBsZW1lbnRzIElFQzJNZXRyaWNGYWN0b3J5U3RyYXRlZ3kge1xuICBwcm90ZWN0ZWQgaW5zdGFuY2VJZHM6IHN0cmluZ1tdO1xuICBwcm90ZWN0ZWQgYXV0b1NjYWxpbmdHcm91cD86IElBdXRvU2NhbGluZ0dyb3VwO1xuXG4gIGNvbnN0cnVjdG9yKGluc3RhbmNlSWRzOiBzdHJpbmdbXSwgYXV0b1NjYWxpbmdHcm91cD86IElBdXRvU2NhbGluZ0dyb3VwKSB7XG4gICAgdGhpcy5pbnN0YW5jZUlkcyA9IGluc3RhbmNlSWRzO1xuICAgIHRoaXMuYXV0b1NjYWxpbmdHcm91cCA9IGF1dG9TY2FsaW5nR3JvdXA7XG4gIH1cblxuICBjcmVhdGVNZXRyaWNzKFxuICAgIG1ldHJpY0ZhY3Rvcnk6IE1ldHJpY0ZhY3RvcnksXG4gICAgbWV0cmljTmFtZTogc3RyaW5nLFxuICAgIHN0YXRpc3RpYzogTWV0cmljU3RhdGlzdGljXG4gICkge1xuICAgIHJldHVybiB0aGlzLmluc3RhbmNlSWRzLm1hcCgoaW5zdGFuY2VJZCkgPT4ge1xuICAgICAgcmV0dXJuIG1ldHJpY0ZhY3RvcnkuY3JlYXRlTWV0cmljKFxuICAgICAgICBtZXRyaWNOYW1lLFxuICAgICAgICBzdGF0aXN0aWMsXG4gICAgICAgIGAke21ldHJpY05hbWV9ICgke2luc3RhbmNlSWR9KWAsXG4gICAgICAgIHJlc29sdmVEaW1lbnNpb25zKHRoaXMuYXV0b1NjYWxpbmdHcm91cCwgaW5zdGFuY2VJZCksXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgRUMyTmFtZXNwYWNlXG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIHNpbmdsZSBtZXRyaWMgc2VhcmNoIGV4cHJlc3Npb24gZm9yIGFsbCBpbnN0YW5jZXMuXG4gKi9cbmNsYXNzIEFsbEluc3RhbmNlc1N0cmF0ZWd5IGltcGxlbWVudHMgSUVDMk1ldHJpY0ZhY3RvcnlTdHJhdGVneSB7XG4gIGNyZWF0ZU1ldHJpY3MoXG4gICAgbWV0cmljRmFjdG9yeTogTWV0cmljRmFjdG9yeSxcbiAgICBtZXRyaWNOYW1lOiBzdHJpbmcsXG4gICAgc3RhdGlzdGljOiBNZXRyaWNTdGF0aXN0aWNcbiAgKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIG1ldHJpY0ZhY3RvcnkuY3JlYXRlTWV0cmljU2VhcmNoKFxuICAgICAgICBgTWV0cmljTmFtZT1cIiR7bWV0cmljTmFtZX1cImAsXG4gICAgICAgIHsgSW5zdGFuY2VJZDogdW5kZWZpbmVkIGFzIHVua25vd24gYXMgc3RyaW5nIH0sXG4gICAgICAgIHN0YXRpc3RpYyxcbiAgICAgICAgRUMyTmFtZXNwYWNlXG4gICAgICApLFxuICAgIF07XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVzb2x2ZURpbWVuc2lvbnMoXG4gIGF1dG9TY2FsaW5nR3JvdXA/OiBJQXV0b1NjYWxpbmdHcm91cCxcbiAgaW5zdGFuY2VJZD86IHN0cmluZ1xuKTogRGltZW5zaW9uc01hcCB7XG4gIGNvbnN0IGRpbWVuc2lvbnM6IERpbWVuc2lvbnNNYXAgPSB7fTtcbiAgaWYgKGF1dG9TY2FsaW5nR3JvdXApIHtcbiAgICBkaW1lbnNpb25zLkF1dG9TY2FsaW5nR3JvdXBOYW1lID0gYXV0b1NjYWxpbmdHcm91cC5hdXRvU2NhbGluZ0dyb3VwTmFtZTtcbiAgfVxuICBpZiAoaW5zdGFuY2VJZCkge1xuICAgIGRpbWVuc2lvbnMuSW5zdGFuY2VJZCA9IGluc3RhbmNlSWQ7XG4gIH1cbiAgcmV0dXJuIGRpbWVuc2lvbnM7XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVTdHJhdGVneShcbiAgcHJvcHM6IEVDMk1ldHJpY0ZhY3RvcnlQcm9wc1xuKTogSUVDMk1ldHJpY0ZhY3RvcnlTdHJhdGVneSB7XG4gIGlmIChwcm9wcy5pbnN0YW5jZUlkcykge1xuICAgIC8vIGluc3RhbmNlIGZpbHRlciArIG9wdGlvbmFsIEFTR1xuICAgIHJldHVybiBuZXcgU2VsZWN0ZWRJbnN0YW5jZXNTdHJhdGVneShcbiAgICAgIHByb3BzLmluc3RhbmNlSWRzLFxuICAgICAgcHJvcHMuYXV0b1NjYWxpbmdHcm91cFxuICAgICk7XG4gIH0gZWxzZSBpZiAocHJvcHMuYXV0b1NjYWxpbmdHcm91cCkge1xuICAgIC8vIEFTRyBvbmx5XG4gICAgcmV0dXJuIG5ldyBBdXRvU2NhbGluZ0dyb3VwU3RyYXRlZ3kocHJvcHMuYXV0b1NjYWxpbmdHcm91cCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gYWxsIGluc3RhbmNlc1xuICAgIHJldHVybiBuZXcgQWxsSW5zdGFuY2VzU3RyYXRlZ3koKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVDMk1ldHJpY0ZhY3RvcnlQcm9wcyB7XG4gIC8qKlxuICAgKiBBdXRvLVNjYWxpbmcgR3JvdXAgdG8gbW9uaXRvci5cbiAgICogQGRlZmF1bHQgLSBubyBBdXRvLVNjYWxpbmcgR3JvdXAgZmlsdGVyXG4gICAqL1xuICByZWFkb25seSBhdXRvU2NhbGluZ0dyb3VwPzogSUF1dG9TY2FsaW5nR3JvdXA7XG4gIC8qKlxuICAgKiBTZWxlY3RlZCBJRHMgb2YgRUMyIGluc3RhbmNlcyB0byBtb25pdG9yLlxuICAgKiBAZGVmYXVsdCAtIG5vIGluc3RhbmNlIGZpbHRlclxuICAgKi9cbiAgcmVhZG9ubHkgaW5zdGFuY2VJZHM/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGNsYXNzIEVDMk1ldHJpY0ZhY3Rvcnkge1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgbWV0cmljRmFjdG9yeTogTWV0cmljRmFjdG9yeTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHN0cmF0ZWd5OiBJRUMyTWV0cmljRmFjdG9yeVN0cmF0ZWd5O1xuXG4gIGNvbnN0cnVjdG9yKG1ldHJpY0ZhY3Rvcnk6IE1ldHJpY0ZhY3RvcnksIHByb3BzOiBFQzJNZXRyaWNGYWN0b3J5UHJvcHMpIHtcbiAgICB0aGlzLm1ldHJpY0ZhY3RvcnkgPSBtZXRyaWNGYWN0b3J5O1xuICAgIHRoaXMuc3RyYXRlZ3kgPSByZXNvbHZlU3RyYXRlZ3kocHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBwZXJjZW50YWdlIG9mIGFsbG9jYXRlZCBFQzIgY29tcHV0ZSB1bml0cyB0aGF0IGFyZSBjdXJyZW50bHkgaW4gdXNlIG9uIHRoZSBpbnN0YW5jZS5cbiAgICogVGhpcyBtZXRyaWMgaWRlbnRpZmllcyB0aGUgcHJvY2Vzc2luZyBwb3dlciByZXF1aXJlZCB0byBydW4gYW4gYXBwbGljYXRpb24gb24gYSBzZWxlY3RlZCBpbnN0YW5jZS5cbiAgICogRGVwZW5kaW5nIG9uIHRoZSBpbnN0YW5jZSB0eXBlLCB0b29scyBpbiB5b3VyIG9wZXJhdGluZyBzeXN0ZW0gY2FuIHNob3cgYSBsb3dlciBwZXJjZW50YWdlIHRoYW5cbiAgICogQ2xvdWRXYXRjaCB3aGVuIHRoZSBpbnN0YW5jZSBpcyBub3QgYWxsb2NhdGVkIGEgZnVsbCBwcm9jZXNzb3IgY29yZS5cbiAgICovXG4gIG1ldHJpY0F2ZXJhZ2VDcHVVdGlsaXNhdGlvblBlcmNlbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlTWV0cmljcyhcIkNQVVV0aWxpemF0aW9uXCIsIE1ldHJpY1N0YXRpc3RpYy5BVkVSQUdFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCeXRlcyByZWFkIGZyb20gYWxsIGluc3RhbmNlIHN0b3JlIHZvbHVtZXMgYXZhaWxhYmxlIHRvIHRoZSBpbnN0YW5jZS5cbiAgICogVGhpcyBtZXRyaWMgaXMgdXNlZCB0byBkZXRlcm1pbmUgdGhlIHZvbHVtZSBvZiB0aGUgZGF0YSB0aGUgYXBwbGljYXRpb24gcmVhZHMgZnJvbSB0aGUgaGFyZCBkaXNrIG9mIHRoZSBpbnN0YW5jZS5cbiAgICogVGhpcyBjYW4gYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIHNwZWVkIG9mIHRoZSBhcHBsaWNhdGlvbi5cbiAgICovXG4gIG1ldHJpY0F2ZXJhZ2VEaXNrUmVhZEJ5dGVzKCkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZURpc2tNZXRyaWNzKFwiUmVhZEJ5dGVzXCIsIE1ldHJpY1N0YXRpc3RpYy5BVkVSQUdFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCeXRlcyB3cml0dGVuIHRvIGFsbCBpbnN0YW5jZSBzdG9yZSB2b2x1bWVzIGF2YWlsYWJsZSB0byB0aGUgaW5zdGFuY2UuXG4gICAqIFRoaXMgbWV0cmljIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSB2b2x1bWUgb2YgdGhlIGRhdGEgdGhlIGFwcGxpY2F0aW9uIHdyaXRlcyBvbnRvIHRoZSBoYXJkIGRpc2sgb2YgdGhlIGluc3RhbmNlLlxuICAgKiBUaGlzIGNhbiBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgc3BlZWQgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgbWV0cmljQXZlcmFnZURpc2tXcml0ZUJ5dGVzKCkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZURpc2tNZXRyaWNzKFwiV3JpdGVCeXRlc1wiLCBNZXRyaWNTdGF0aXN0aWMuQVZFUkFHRSk7XG4gIH1cblxuICAvKipcbiAgICogQ29tcGxldGVkIHJlYWQgb3BlcmF0aW9ucyBmcm9tIGFsbCBpbnN0YW5jZSBzdG9yZSB2b2x1bWVzIGF2YWlsYWJsZSB0byB0aGUgaW5zdGFuY2UgaW4gYSBzcGVjaWZpZWQgcGVyaW9kIG9mIHRpbWUuXG4gICAqL1xuICBtZXRyaWNBdmVyYWdlRGlza1JlYWRPcHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlRGlza01ldHJpY3MoXCJSZWFkT3BzXCIsIE1ldHJpY1N0YXRpc3RpYy5BVkVSQUdFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wbGV0ZWQgd3JpdGUgb3BlcmF0aW9ucyB0byBhbGwgaW5zdGFuY2Ugc3RvcmUgdm9sdW1lcyBhdmFpbGFibGUgdG8gdGhlIGluc3RhbmNlIGluIGEgc3BlY2lmaWVkIHBlcmlvZCBvZiB0aW1lLlxuICAgKi9cbiAgbWV0cmljQXZlcmFnZURpc2tXcml0ZU9wcygpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVEaXNrTWV0cmljcyhcIldyaXRlT3BzXCIsIE1ldHJpY1N0YXRpc3RpYy5BVkVSQUdFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGJ5dGVzIHJlY2VpdmVkIG9uIGFsbCBuZXR3b3JrIGludGVyZmFjZXMgYnkgdGhlIGluc3RhbmNlLlxuICAgKiBUaGlzIG1ldHJpYyBpZGVudGlmaWVzIHRoZSB2b2x1bWUgb2YgaW5jb21pbmcgbmV0d29yayB0cmFmZmljIHRvIGEgc2luZ2xlIGluc3RhbmNlLlxuICAgKi9cbiAgbWV0cmljQXZlcmFnZU5ldHdvcmtJblJhdGVCeXRlcygpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVNZXRyaWNzKFwiTmV0d29ya0luXCIsIE1ldHJpY1N0YXRpc3RpYy5BVkVSQUdFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGJ5dGVzIHNlbnQgb3V0IG9uIGFsbCBuZXR3b3JrIGludGVyZmFjZXMgYnkgdGhlIGluc3RhbmNlLlxuICAgKiBUaGlzIG1ldHJpYyBpZGVudGlmaWVzIHRoZSB2b2x1bWUgb2Ygb3V0Z29pbmcgbmV0d29yayB0cmFmZmljIGZyb20gYSBzaW5nbGUgaW5zdGFuY2UuXG4gICAqL1xuICBtZXRyaWNBdmVyYWdlTmV0d29ya091dFJhdGVCeXRlcygpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVNZXRyaWNzKFwiTmV0d29ya091dFwiLCBNZXRyaWNTdGF0aXN0aWMuQVZFUkFHRSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURpc2tNZXRyaWNzKG1ldHJpY05hbWU6IHN0cmluZywgc3RhdGlzdGljOiBNZXRyaWNTdGF0aXN0aWMpIHtcbiAgICBjb25zdCBjbGFzc2ljTWV0cmljcyA9IHRoaXMuc3RyYXRlZ3kuY3JlYXRlTWV0cmljcyhcbiAgICAgIHRoaXMubWV0cmljRmFjdG9yeSxcbiAgICAgIGBEaXNrJHttZXRyaWNOYW1lfWAsXG4gICAgICBzdGF0aXN0aWNcbiAgICApO1xuICAgIGNvbnN0IGVic01ldHJpY3MgPSB0aGlzLnN0cmF0ZWd5LmNyZWF0ZU1ldHJpY3MoXG4gICAgICB0aGlzLm1ldHJpY0ZhY3RvcnksXG4gICAgICBgRUJTJHttZXRyaWNOYW1lfWAsXG4gICAgICBzdGF0aXN0aWNcbiAgICApO1xuXG4gICAgcmV0dXJuIGNsYXNzaWNNZXRyaWNzLm1hcCgoY2xhc3NpYywgaSkgPT4ge1xuICAgICAgY29uc3QgZWJzID0gZWJzTWV0cmljc1tpXTtcbiAgICAgIGNvbnN0IHVzaW5nTWV0cmljczogUmVjb3JkPHN0cmluZywgSU1ldHJpYz4gPSB7fTtcbiAgICAgIGNvbnN0IGNsYXNzaWNJZCA9IGAke21ldHJpY05hbWUudG9Mb3dlckNhc2UoKX1fY2xhc3NpY18ke2l9YDtcbiAgICAgIGNvbnN0IGVic0lkID0gYCR7bWV0cmljTmFtZS50b0xvd2VyQ2FzZSgpfV9lYnNfJHtpfWA7XG4gICAgICB1c2luZ01ldHJpY3NbY2xhc3NpY0lkXSA9IGNsYXNzaWM7XG4gICAgICB1c2luZ01ldHJpY3NbZWJzSWRdID0gZWJzO1xuICAgICAgcmV0dXJuIHRoaXMubWV0cmljRmFjdG9yeS5jcmVhdGVNZXRyaWNNYXRoKFxuICAgICAgICBgQVZHKFJFTU9WRV9FTVBUWShbJHtjbGFzc2ljSWR9LCAke2Vic0lkfV0pKWAsXG4gICAgICAgIHVzaW5nTWV0cmljcyxcbiAgICAgICAgYERpc2ske21ldHJpY05hbWV9YFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWV0cmljcyhtZXRyaWNOYW1lOiBzdHJpbmcsIHN0YXRpc3RpYzogTWV0cmljU3RhdGlzdGljKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyYXRlZ3kuY3JlYXRlTWV0cmljcyhcbiAgICAgIHRoaXMubWV0cmljRmFjdG9yeSxcbiAgICAgIG1ldHJpY05hbWUsXG4gICAgICBzdGF0aXN0aWNcbiAgICApO1xuICB9XG59XG4iXX0=