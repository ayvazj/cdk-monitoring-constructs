"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.KinesisFirehoseMonitoring = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cloudwatch_1 = require("aws-cdk-lib/aws-cloudwatch");
const KinesisFirehoseMetricFactory_1 = require("./KinesisFirehoseMetricFactory");
const common_1 = require("../../common");
const dashboard_1 = require("../../dashboard");
class KinesisFirehoseMonitoring extends common_1.Monitoring {
    constructor(scope, props) {
        super(scope);
        const namingStrategy = new dashboard_1.MonitoringNamingStrategy({
            ...props,
            fallbackConstructName: props.deliveryStreamName,
        });
        this.title = namingStrategy.resolveHumanReadableName();
        this.streamUrl = scope
            .createAwsConsoleUrlFactory()
            .getKinesisFirehoseDeliveryStreamUrl(props.deliveryStreamName);
        const metricFactory = new KinesisFirehoseMetricFactory_1.KinesisFirehoseMetricFactory(scope.createMetricFactory(), props);
        const alarmFactory = this.createAlarmFactory(namingStrategy.resolveAlarmFriendlyName());
        this.kinesisAlarmFactory = new common_1.KinesisAlarmFactory(alarmFactory);
        this.recordCountAnnotations = [];
        this.incomingLimitAnnotations = [{ value: 1, label: "100% usage" }];
        this.incomingBytesMetric = metricFactory.metricIncomingBytes();
        this.incomingRecordsMetric = metricFactory.metricIncomingRecordCount();
        this.throttledRecordsMetric = metricFactory.metricThrottledRecordCount();
        this.successfulConversionMetric =
            metricFactory.metricSuccessfulConversionCount();
        this.failedConversionMetric = metricFactory.metricFailedConversionCount();
        this.putRecordLatency = metricFactory.metricPutRecordLatencyP90InMillis();
        this.putRecordBatchLatency =
            metricFactory.metricPutRecordBatchLatencyP90InMillis();
        this.incomingBytesToLimitRate =
            metricFactory.metricIncomingBytesToLimitRate();
        this.incomingRecordsToLimitRate =
            metricFactory.metricIncomingRecordsToLimitRate();
        this.incomingPutRequestsToLimitRate =
            metricFactory.metricIncomingPutRequestsToLimitRate();
        for (const disambiguator in props.addRecordsThrottledAlarm) {
            const alarmProps = props.addRecordsThrottledAlarm[disambiguator];
            const createdAlarm = this.kinesisAlarmFactory.addPutRecordsThrottledAlarm(this.throttledRecordsMetric, alarmProps, disambiguator);
            this.recordCountAnnotations.push(createdAlarm.annotation);
            this.addAlarm(createdAlarm);
        }
        for (const disambiguator in props.addIncomingBytesExceedThresholdAlarm) {
            const alarmProps = props.addIncomingBytesExceedThresholdAlarm[disambiguator];
            const createdAlarm = this.kinesisAlarmFactory.addFirehoseStreamExceedSafetyThresholdAlarm(this.incomingBytesToLimitRate, "IncomingBytes", "BytesPerSecondLimit", alarmProps, disambiguator);
            this.incomingLimitAnnotations.push(createdAlarm.annotation);
            this.addAlarm(createdAlarm);
        }
        for (const disambiguator in props.addIncomingRecordsExceedThresholdAlarm) {
            const alarmProps = props.addIncomingRecordsExceedThresholdAlarm[disambiguator];
            const createdAlarm = this.kinesisAlarmFactory.addFirehoseStreamExceedSafetyThresholdAlarm(this.incomingRecordsToLimitRate, "IncomingRecords", "RecordsPerSecondLimit", alarmProps, disambiguator);
            this.incomingLimitAnnotations.push(createdAlarm.annotation);
            this.addAlarm(createdAlarm);
        }
        for (const disambiguator in props.addIncomingPutRequestsExceedThresholdAlarm) {
            const alarmProps = props.addIncomingPutRequestsExceedThresholdAlarm[disambiguator];
            const createdAlarm = this.kinesisAlarmFactory.addFirehoseStreamExceedSafetyThresholdAlarm(this.incomingPutRequestsToLimitRate, "IncomingPutRequests", "PutRequestsPerSecondLimit", alarmProps, disambiguator);
            this.incomingLimitAnnotations.push(createdAlarm.annotation);
            this.addAlarm(createdAlarm);
        }
        props.useCreatedAlarms?.consume(this.createdAlarms());
    }
    summaryWidgets() {
        return [
            this.createTitleWidget(),
            this.createIncomingRecordWidget(common_1.HalfWidth, common_1.DefaultSummaryWidgetHeight),
            this.createConversionWidget(common_1.HalfWidth, common_1.DefaultSummaryWidgetHeight),
        ];
    }
    widgets() {
        return [
            this.createTitleWidget(),
            this.createIncomingRecordWidget(common_1.QuarterWidth, common_1.DefaultGraphWidgetHeight),
            this.createLatencyWidget(common_1.QuarterWidth, common_1.DefaultGraphWidgetHeight),
            this.createConversionWidget(common_1.QuarterWidth, common_1.DefaultGraphWidgetHeight),
            this.createLimitWidget(common_1.QuarterWidth, common_1.DefaultGraphWidgetHeight),
        ];
    }
    createTitleWidget() {
        return new dashboard_1.MonitoringHeaderWidget({
            family: "Firehose Delivery Stream",
            title: this.title,
            goToLinkUrl: this.streamUrl,
        });
    }
    createIncomingRecordWidget(width, height) {
        return new aws_cloudwatch_1.GraphWidget({
            width,
            height,
            title: "Records",
            left: [this.incomingRecordsMetric, this.throttledRecordsMetric],
            leftYAxis: common_1.CountAxisFromZero,
            leftAnnotations: this.recordCountAnnotations,
        });
    }
    createLatencyWidget(width, height) {
        return new aws_cloudwatch_1.GraphWidget({
            width,
            height,
            title: "Latency (P90)",
            left: [this.putRecordLatency, this.putRecordBatchLatency],
            leftYAxis: common_1.TimeAxisMillisFromZero,
        });
    }
    createConversionWidget(width, height) {
        return new aws_cloudwatch_1.GraphWidget({
            width,
            height,
            title: "Conversions",
            left: [this.successfulConversionMetric, this.failedConversionMetric],
            leftYAxis: common_1.CountAxisFromZero,
        });
    }
    createLimitWidget(width, height) {
        return new aws_cloudwatch_1.GraphWidget({
            width,
            height,
            title: "Limits (rate)",
            left: [
                this.incomingBytesToLimitRate.with({ label: "Bytes" }),
                this.incomingRecordsToLimitRate.with({ label: "Records" }),
                this.incomingPutRequestsToLimitRate.with({ label: "PutRequests" }),
            ],
            leftYAxis: common_1.RateAxisFromZero,
            leftAnnotations: this.incomingLimitAnnotations,
        });
    }
}
exports.KinesisFirehoseMonitoring = KinesisFirehoseMonitoring;
_a = JSII_RTTI_SYMBOL_1;
KinesisFirehoseMonitoring[_a] = { fqn: "cdk-monitoring-constructs.KinesisFirehoseMonitoring", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS2luZXNpc0ZpcmVob3NlTW9uaXRvcmluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIktpbmVzaXNGaXJlaG9zZU1vbml0b3JpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwrREFJb0M7QUFFcEMsaUZBR3dDO0FBQ3hDLHlDQWVzQjtBQUN0QiwrQ0FHeUI7QUFzQnpCLE1BQWEseUJBQTBCLFNBQVEsbUJBQVU7SUFtQnZELFlBQVksS0FBc0IsRUFBRSxLQUFxQztRQUN2RSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFYixNQUFNLGNBQWMsR0FBRyxJQUFJLG9DQUF3QixDQUFDO1lBQ2xELEdBQUcsS0FBSztZQUNSLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxrQkFBa0I7U0FDaEQsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLEtBQUssR0FBRyxjQUFjLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUN2RCxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUs7YUFDbkIsMEJBQTBCLEVBQUU7YUFDNUIsbUNBQW1DLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFakUsTUFBTSxhQUFhLEdBQUcsSUFBSSwyREFBNEIsQ0FDcEQsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEVBQzNCLEtBQUssQ0FDTixDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUMxQyxjQUFjLENBQUMsd0JBQXdCLEVBQUUsQ0FDMUMsQ0FBQztRQUNGLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLDRCQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLHdCQUF3QixHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBRXBFLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxh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QUF3QjtTQUMvQyxDQUFDLENBQUM7SUFDTCxDQUFDOztBQTNMSCw4REE0TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBHcmFwaFdpZGdldCxcbiAgSG9yaXpvbnRhbEFubm90YXRpb24sXG4gIElXaWRnZXQsXG59IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2xvdWR3YXRjaFwiO1xuXG5pbXBvcnQge1xuICBLaW5lc2lzRmlyZWhvc2VNZXRyaWNGYWN0b3J5LFxuICBLaW5lc2lzRmlyZWhvc2VNZXRyaWNGYWN0b3J5UHJvcHMsXG59IGZyb20gXCIuL0tpbmVzaXNGaXJlaG9zZU1ldHJpY0ZhY3RvcnlcIjtcbmltcG9ydCB7XG4gIEJhc2VNb25pdG9yaW5nUHJvcHMsXG4gIENvdW50QXhpc0Zyb21aZXJvLFxuICBEZWZhdWx0R3JhcGhXaWRnZXRIZWlnaHQsXG4gIERlZmF1bHRTdW1tYXJ5V2lkZ2V0SGVpZ2h0LFxuICBIYWxmV2lkdGgsXG4gIEtpbmVzaXNBbGFybUZhY3RvcnksXG4gIE1ldHJpY1dpdGhBbGFybVN1cHBvcnQsXG4gIE1vbml0b3JpbmcsXG4gIE1vbml0b3JpbmdTY29wZSxcbiAgUXVhcnRlcldpZHRoLFxuICBSYXRlQXhpc0Zyb21aZXJvLFxuICBSZWNvcmRzVGhyb3R0bGVkVGhyZXNob2xkLFxuICBGaXJlaG9zZVN0cmVhbUxpbWl0VGhyZXNob2xkLFxuICBUaW1lQXhpc01pbGxpc0Zyb21aZXJvLFxufSBmcm9tIFwiLi4vLi4vY29tbW9uXCI7XG5pbXBvcnQge1xuICBNb25pdG9yaW5nSGVhZGVyV2lkZ2V0LFxuICBNb25pdG9yaW5nTmFtaW5nU3RyYXRlZ3ksXG59IGZyb20gXCIuLi8uLi9kYXNoYm9hcmRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBLaW5lc2lzRmlyZWhvc2VNb25pdG9yaW5nT3B0aW9ucyBleHRlbmRzIEJhc2VNb25pdG9yaW5nUHJvcHMge1xuICByZWFkb25seSBhZGRSZWNvcmRzVGhyb3R0bGVkQWxhcm0/OiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmRzVGhyb3R0bGVkVGhyZXNob2xkPjtcbiAgcmVhZG9ubHkgYWRkSW5jb21pbmdCeXRlc0V4Y2VlZFRocmVzaG9sZEFsYXJtPzogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICBGaXJlaG9zZVN0cmVhbUxpbWl0VGhyZXNob2xkXG4gID47XG4gIHJlYWRvbmx5IGFkZEluY29taW5nUmVjb3Jkc0V4Y2VlZFRocmVzaG9sZEFsYXJtPzogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICBGaXJlaG9zZVN0cmVhbUxpbWl0VGhyZXNob2xkXG4gID47XG4gIHJlYWRvbmx5IGFkZEluY29taW5nUHV0UmVxdWVzdHNFeGNlZWRUaHJlc2hvbGRBbGFybT86IFJlY29yZDxcbiAgICBzdHJpbmcsXG4gICAgRmlyZWhvc2VTdHJlYW1MaW1pdFRocmVzaG9sZFxuICA+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEtpbmVzaXNGaXJlaG9zZU1vbml0b3JpbmdQcm9wc1xuICBleHRlbmRzIEtpbmVzaXNGaXJlaG9zZU1ldHJpY0ZhY3RvcnlQcm9wcyxcbiAgICBLaW5lc2lzRmlyZWhvc2VNb25pdG9yaW5nT3B0aW9ucyB7fVxuXG5leHBvcnQgY2xhc3MgS2luZXNpc0ZpcmVob3NlTW9uaXRvcmluZyBleHRlbmRzIE1vbml0b3Jpbmcge1xuICByZWFkb25seSB0aXRsZTogc3RyaW5nO1xuICByZWFkb25seSBzdHJlYW1Vcmw/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkga2luZXNpc0FsYXJtRmFjdG9yeTogS2luZXNpc0FsYXJtRmFjdG9yeTtcbiAgcmVhZG9ubHkgcmVjb3JkQ291bnRBbm5vdGF0aW9uczogSG9yaXpvbnRhbEFubm90YXRpb25bXTtcbiAgcmVhZG9ubHkgaW5jb21pbmdMaW1pdEFubm90YXRpb25zOiBIb3Jpem9udGFsQW5ub3RhdGlvbltdO1xuXG4gIHJlYWRvbmx5IGluY29taW5nQnl0ZXNNZXRyaWM6IE1ldHJpY1dpdGhBbGFybVN1cHBvcnQ7XG4gIHJlYWRvbmx5IGluY29taW5nUmVjb3Jkc01ldHJpYzogTWV0cmljV2l0aEFsYXJtU3VwcG9ydDtcbiAgcmVhZG9ubHkgdGhyb3R0bGVkUmVjb3Jkc01ldHJpYzogTWV0cmljV2l0aEFsYXJtU3VwcG9ydDtcbiAgcmVhZG9ubHkgc3VjY2Vzc2Z1bENvbnZlcnNpb25NZXRyaWM6IE1ldHJpY1dpdGhBbGFybVN1cHBvcnQ7XG4gIHJlYWRvbmx5IGZhaWxlZENvbnZlcnNpb25NZXRyaWM6IE1ldHJpY1dpdGhBbGFybVN1cHBvcnQ7XG4gIHJlYWRvbmx5IHB1dFJlY29yZExhdGVuY3k6IE1ldHJpY1dpdGhBbGFybVN1cHBvcnQ7XG4gIHJlYWRvbmx5IHB1dFJlY29yZEJhdGNoTGF0ZW5jeTogTWV0cmljV2l0aEFsYXJtU3VwcG9ydDtcbiAgcmVhZG9ubHkgaW5jb21pbmdCeXRlc1RvTGltaXRSYXRlOiBNZXRyaWNXaXRoQWxhcm1TdXBwb3J0O1xuICByZWFkb25seSBpbmNvbWluZ1JlY29yZHNUb0xpbWl0UmF0ZTogTWV0cmljV2l0aEFsYXJtU3VwcG9ydDtcbiAgcmVhZG9ubHkgaW5jb21pbmdQdXRSZXF1ZXN0c1RvTGltaXRSYXRlOiBNZXRyaWNXaXRoQWxhcm1TdXBwb3J0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBNb25pdG9yaW5nU2NvcGUsIHByb3BzOiBLaW5lc2lzRmlyZWhvc2VNb25pdG9yaW5nUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSk7XG5cbiAgICBjb25zdCBuYW1pbmdTdHJhdGVneSA9IG5ldyBNb25pdG9yaW5nTmFtaW5nU3RyYXRlZ3koe1xuICAgICAgLi4ucHJvcHMsXG4gICAgICBmYWxsYmFja0NvbnN0cnVjdE5hbWU6IHByb3BzLmRlbGl2ZXJ5U3RyZWFtTmFtZSxcbiAgICB9KTtcbiAgICB0aGlzLnRpdGxlID0gbmFtaW5nU3RyYXRlZ3kucmVzb2x2ZUh1bWFuUmVhZGFibGVOYW1lKCk7XG4gICAgdGhpcy5zdHJlYW1VcmwgPSBzY29wZVxuICAgICAgLmNyZWF0ZUF3c0NvbnNvbGVVcmxGYWN0b3J5KClcbiAgICAgIC5nZXRLaW5lc2lzRmlyZWhvc2VEZWxpdmVyeVN0cmVhbVVybChwcm9wcy5kZWxpdmVyeVN0cmVhbU5hbWUpO1xuXG4gICAgY29uc3QgbWV0cmljRmFjdG9yeSA9IG5ldyBLaW5lc2lzRmlyZWhvc2VNZXRyaWNGYWN0b3J5KFxuICAgICAgc2NvcGUuY3JlYXRlTWV0cmljRmFjdG9yeSgpLFxuICAgICAgcHJvcHNcbiAgICApO1xuICAgIGNvbnN0IGFsYXJtRmFjdG9yeSA9IHRoaXMuY3JlYXRlQWxhcm1GYWN0b3J5KFxuICAgICAgbmFtaW5nU3RyYXRlZ3kucmVzb2x2ZUFsYXJtRnJpZW5kbHlOYW1lKClcbiAgICApO1xuICAgIHRoaXMua2luZXNpc0FsYXJtRmFjdG9yeSA9IG5ldyBLaW5lc2lzQWxhcm1GYWN0b3J5KGFsYXJtRmFjdG9yeSk7XG4gICAgdGhpcy5yZWNvcmRDb3VudEFubm90YXRpb25zID0gW107XG4gICAgdGhpcy5pbmNvbWluZ0xpbWl0QW5ub3RhdGlvbnMgPSBbeyB2YWx1ZTogMSwgbGFiZWw6IFwiMTAwJSB1c2FnZVwiIH1dO1xuXG4gICAgdGhpcy5pbmNvbWluZ0J5dGVzTWV0cmljID0gbWV0cmljRmFjdG9yeS5tZXRyaWNJbmNvbWluZ0J5dGVzKCk7XG4gICAgdGhpcy5pbmNvbWluZ1JlY29yZHNNZXRyaWMgPSBtZXRyaWNGYWN0b3J5Lm1ldHJpY0luY29taW5nUmVjb3JkQ291bnQoKTtcbiAgICB0aGlzLnRocm90dGxlZFJlY29yZHNNZXRyaWMgPSBtZXRyaWNGYWN0b3J5Lm1ldHJpY1Rocm90dGxlZFJlY29yZENvdW50KCk7XG4gICAgdGhpcy5zdWNjZXNzZnVsQ29udmVyc2lvbk1ldHJpYyA9XG4gICAgICBtZXRyaWNGYWN0b3J5Lm1ldHJpY1N1Y2Nlc3NmdWxDb252ZXJzaW9uQ291bnQoKTtcbiAgICB0aGlzLmZhaWxlZENvbnZlcnNpb25NZXRyaWMgPSBtZXRyaWNGYWN0b3J5Lm1ldHJpY0ZhaWxlZENvbnZlcnNpb25Db3VudCgpO1xuICAgIHRoaXMucHV0UmVjb3JkTGF0ZW5jeSA9IG1ldHJpY0ZhY3RvcnkubWV0cmljUHV0UmVjb3JkTGF0ZW5jeVA5MEluTWlsbGlzKCk7XG4gICAgdGhpcy5wdXRSZWNvcmRCYXRjaExhdGVuY3kgPVxuICAgICAgbWV0cmljRmFjdG9yeS5tZXRyaWNQdXRSZWNvcmRCYXRjaExhdGVuY3lQOTBJbk1pbGxpcygpO1xuICAgIHRoaXMuaW5jb21pbmdCeXRlc1RvTGltaXRSYXRlID1cbiAgICAgIG1ldHJpY0ZhY3RvcnkubWV0cmljSW5jb21pbmdCeXRlc1RvTGltaXRSYXRlKCk7XG4gICAgdGhpcy5pbmNvbWluZ1JlY29yZHNUb0xpbWl0UmF0ZSA9XG4gICAgICBtZXRyaWNGYWN0b3J5Lm1ldHJpY0luY29taW5nUmVjb3Jkc1RvTGltaXRSYXRlKCk7XG4gICAgdGhpcy5pbmNvbWluZ1B1dFJlcXVlc3RzVG9MaW1pdFJhdGUgPVxuICAgICAgbWV0cmljRmFjdG9yeS5tZXRyaWNJbmNvbWluZ1B1dFJlcXVlc3RzVG9MaW1pdFJhdGUoKTtcblxuICAgIGZvciAoY29uc3QgZGlzYW1iaWd1YXRvciBpbiBwcm9wcy5hZGRSZWNvcmRzVGhyb3R0bGVkQWxhcm0pIHtcbiAgICAgIGNvbnN0IGFsYXJtUHJvcHMgPSBwcm9wcy5hZGRSZWNvcmRzVGhyb3R0bGVkQWxhcm1bZGlzYW1iaWd1YXRvcl07XG4gICAgICBjb25zdCBjcmVhdGVkQWxhcm0gPSB0aGlzLmtpbmVzaXNBbGFybUZhY3RvcnkuYWRkUHV0UmVjb3Jkc1Rocm90dGxlZEFsYXJtKFxuICAgICAgICB0aGlzLnRocm90dGxlZFJlY29yZHNNZXRyaWMsXG4gICAgICAgIGFsYXJtUHJvcHMsXG4gICAgICAgIGRpc2FtYmlndWF0b3JcbiAgICAgICk7XG4gICAgICB0aGlzLnJlY29yZENvdW50QW5ub3RhdGlvbnMucHVzaChjcmVhdGVkQWxhcm0uYW5ub3RhdGlvbik7XG4gICAgICB0aGlzLmFkZEFsYXJtKGNyZWF0ZWRBbGFybSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBkaXNhbWJpZ3VhdG9yIGluIHByb3BzLmFkZEluY29taW5nQnl0ZXNFeGNlZWRUaHJlc2hvbGRBbGFybSkge1xuICAgICAgY29uc3QgYWxhcm1Qcm9wcyA9XG4gICAgICAgIHByb3BzLmFkZEluY29taW5nQnl0ZXNFeGNlZWRUaHJlc2hvbGRBbGFybVtkaXNhbWJpZ3VhdG9yXTtcbiAgICAgIGNvbnN0IGNyZWF0ZWRBbGFybSA9XG4gICAgICAgIHRoaXMua2luZXNpc0FsYXJtRmFjdG9yeS5hZGRGaXJlaG9zZVN0cmVhbUV4Y2VlZFNhZmV0eVRocmVzaG9sZEFsYXJtKFxuICAgICAgICAgIHRoaXMuaW5jb21pbmdCeXRlc1RvTGltaXRSYXRlLFxuICAgICAgICAgIFwiSW5jb21pbmdCeXRlc1wiLFxuICAgICAgICAgIFwiQnl0ZXNQZXJTZWNvbmRMaW1pdFwiLFxuICAgICAgICAgIGFsYXJtUHJvcHMsXG4gICAgICAgICAgZGlzYW1iaWd1YXRvclxuICAgICAgICApO1xuICAgICAgdGhpcy5pbmNvbWluZ0xpbWl0QW5ub3RhdGlvbnMucHVzaChjcmVhdGVkQWxhcm0uYW5ub3RhdGlvbik7XG4gICAgICB0aGlzLmFkZEFsYXJtKGNyZWF0ZWRBbGFybSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBkaXNhbWJpZ3VhdG9yIGluIHByb3BzLmFkZEluY29taW5nUmVjb3Jkc0V4Y2VlZFRocmVzaG9sZEFsYXJtKSB7XG4gICAgICBjb25zdCBhbGFybVByb3BzID1cbiAgICAgICAgcHJvcHMuYWRkSW5jb21pbmdSZWNvcmRzRXhjZWVkVGhyZXNob2xkQWxhcm1bZGlzYW1iaWd1YXRvcl07XG4gICAgICBjb25zdCBjcmVhdGVkQWxhcm0gPVxuICAgICAgICB0aGlzLmtpbmVzaXNBbGFybUZhY3RvcnkuYWRkRmlyZWhvc2VTdHJlYW1FeGNlZWRTYWZldHlUaHJlc2hvbGRBbGFybShcbiAgICAgICAgICB0aGlzLmluY29taW5nUmVjb3Jkc1RvTGltaXRSYXRlLFxuICAgICAgICAgIFwiSW5jb21pbmdSZWNvcmRzXCIsXG4gICAgICAgICAgXCJSZWNvcmRzUGVyU2Vjb25kTGltaXRcIixcbiAgICAgICAgICBhbGFybVByb3BzLFxuICAgICAgICAgIGRpc2FtYmlndWF0b3JcbiAgICAgICAgKTtcbiAgICAgIHRoaXMuaW5jb21pbmdMaW1pdEFubm90YXRpb25zLnB1c2goY3JlYXRlZEFsYXJtLmFubm90YXRpb24pO1xuICAgICAgdGhpcy5hZGRBbGFybShjcmVhdGVkQWxhcm0pO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZGlzYW1iaWd1YXRvciBpbiBwcm9wcy5hZGRJbmNvbWluZ1B1dFJlcXVlc3RzRXhjZWVkVGhyZXNob2xkQWxhcm0pIHtcbiAgICAgIGNvbnN0IGFsYXJtUHJvcHMgPVxuICAgICAgICBwcm9wcy5hZGRJbmNvbWluZ1B1dFJlcXVlc3RzRXhjZWVkVGhyZXNob2xkQWxhcm1bZGlzYW1iaWd1YXRvcl07XG4gICAgICBjb25zdCBjcmVhdGVkQWxhcm0gPVxuICAgICAgICB0aGlzLmtpbmVzaXNBbGFybUZhY3RvcnkuYWRkRmlyZWhvc2VTdHJlYW1FeGNlZWRTYWZldHlUaHJlc2hvbGRBbGFybShcbiAgICAgICAgICB0aGlzLmluY29taW5nUHV0UmVxdWVzdHNUb0xpbWl0UmF0ZSxcbiAgICAgICAgICBcIkluY29taW5nUHV0UmVxdWVzdHNcIixcbiAgICAgICAgICBcIlB1dFJlcXVlc3RzUGVyU2Vjb25kTGltaXRcIixcbiAgICAgICAgICBhbGFybVByb3BzLFxuICAgICAgICAgIGRpc2FtYmlndWF0b3JcbiAgICAgICAgKTtcbiAgICAgIHRoaXMuaW5jb21pbmdMaW1pdEFubm90YXRpb25zLnB1c2goY3JlYXRlZEFsYXJtLmFubm90YXRpb24pO1xuICAgICAgdGhpcy5hZGRBbGFybShjcmVhdGVkQWxhcm0pO1xuICAgIH1cblxuICAgIHByb3BzLnVzZUNyZWF0ZWRBbGFybXM/LmNvbnN1bWUodGhpcy5jcmVhdGVkQWxhcm1zKCkpO1xuICB9XG5cbiAgc3VtbWFyeVdpZGdldHMoKTogSVdpZGdldFtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgdGhpcy5jcmVhdGVUaXRsZVdpZGdldCgpLFxuICAgICAgdGhpcy5jcmVhdGVJbmNvbWluZ1JlY29yZFdpZGdldChIYWxmV2lkdGgsIERlZmF1bHRTdW1tYXJ5V2lkZ2V0SGVpZ2h0KSxcbiAgICAgIHRoaXMuY3JlYXRlQ29udmVyc2lvbldpZGdldChIYWxmV2lkdGgsIERlZmF1bHRTdW1tYXJ5V2lkZ2V0SGVpZ2h0KSxcbiAgICBdO1xuICB9XG5cbiAgd2lkZ2V0cygpOiBJV2lkZ2V0W10ge1xuICAgIHJldHVybiBbXG4gICAgICB0aGlzLmNyZWF0ZVRpdGxlV2lkZ2V0KCksXG4gICAgICB0aGlzLmNyZWF0ZUluY29taW5nUmVjb3JkV2lkZ2V0KFF1YXJ0ZXJXaWR0aCwgRGVmYXVsdEdyYXBoV2lkZ2V0SGVpZ2h0KSxcbiAgICAgIHRoaXMuY3JlYXRlTGF0ZW5jeVdpZGdldChRdWFydGVyV2lkdGgsIERlZmF1bHRHcmFwaFdpZGdldEhlaWdodCksXG4gICAgICB0aGlzLmNyZWF0ZUNvbnZlcnNpb25XaWRnZXQoUXVhcnRlcldpZHRoLCBEZWZhdWx0R3JhcGhXaWRnZXRIZWlnaHQpLFxuICAgICAgdGhpcy5jcmVhdGVMaW1pdFdpZGdldChRdWFydGVyV2lkdGgsIERlZmF1bHRHcmFwaFdpZGdldEhlaWdodCksXG4gICAgXTtcbiAgfVxuXG4gIGNyZWF0ZVRpdGxlV2lkZ2V0KCkge1xuICAgIHJldHVybiBuZXcgTW9uaXRvcmluZ0hlYWRlcldpZGdldCh7XG4gICAgICBmYW1pbHk6IFwiRmlyZWhvc2UgRGVsaXZlcnkgU3RyZWFtXCIsXG4gICAgICB0aXRsZTogdGhpcy50aXRsZSxcbiAgICAgIGdvVG9MaW5rVXJsOiB0aGlzLnN0cmVhbVVybCxcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZUluY29taW5nUmVjb3JkV2lkZ2V0KHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFdpZGdldCh7XG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICAgIHRpdGxlOiBcIlJlY29yZHNcIixcbiAgICAgIGxlZnQ6IFt0aGlzLmluY29taW5nUmVjb3Jkc01ldHJpYywgdGhpcy50aHJvdHRsZWRSZWNvcmRzTWV0cmljXSxcbiAgICAgIGxlZnRZQXhpczogQ291bnRBeGlzRnJvbVplcm8sXG4gICAgICBsZWZ0QW5ub3RhdGlvbnM6IHRoaXMucmVjb3JkQ291bnRBbm5vdGF0aW9ucyxcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZUxhdGVuY3lXaWRnZXQod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICByZXR1cm4gbmV3IEdyYXBoV2lkZ2V0KHtcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0LFxuICAgICAgdGl0bGU6IFwiTGF0ZW5jeSAoUDkwKVwiLFxuICAgICAgbGVmdDogW3RoaXMucHV0UmVjb3JkTGF0ZW5jeSwgdGhpcy5wdXRSZWNvcmRCYXRjaExhdGVuY3ldLFxuICAgICAgbGVmdFlBeGlzOiBUaW1lQXhpc01pbGxpc0Zyb21aZXJvLFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlQ29udmVyc2lvbldpZGdldCh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xuICAgIHJldHVybiBuZXcgR3JhcGhXaWRnZXQoe1xuICAgICAgd2lkdGgsXG4gICAgICBoZWlnaHQsXG4gICAgICB0aXRsZTogXCJDb252ZXJzaW9uc1wiLFxuICAgICAgbGVmdDogW3RoaXMuc3VjY2Vzc2Z1bENvbnZlcnNpb25NZXRyaWMsIHRoaXMuZmFpbGVkQ29udmVyc2lvbk1ldHJpY10sXG4gICAgICBsZWZ0WUF4aXM6IENvdW50QXhpc0Zyb21aZXJvLFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlTGltaXRXaWRnZXQod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICByZXR1cm4gbmV3IEdyYXBoV2lkZ2V0KHtcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0LFxuICAgICAgdGl0bGU6IFwiTGltaXRzIChyYXRlKVwiLFxuICAgICAgbGVmdDogW1xuICAgICAgICB0aGlzLmluY29taW5nQnl0ZXNUb0xpbWl0UmF0ZS53aXRoKHsgbGFiZWw6IFwiQnl0ZXNcIiB9KSxcbiAgICAgICAgdGhpcy5pbmNvbWluZ1JlY29yZHNUb0xpbWl0UmF0ZS53aXRoKHsgbGFiZWw6IFwiUmVjb3Jkc1wiIH0pLFxuICAgICAgICB0aGlzLmluY29taW5nUHV0UmVxdWVzdHNUb0xpbWl0UmF0ZS53aXRoKHsgbGFiZWw6IFwiUHV0UmVxdWVzdHNcIiB9KSxcbiAgICAgIF0sXG4gICAgICBsZWZ0WUF4aXM6IFJhdGVBeGlzRnJvbVplcm8sXG4gICAgICBsZWZ0QW5ub3RhdGlvbnM6IHRoaXMuaW5jb21pbmdMaW1pdEFubm90YXRpb25zLFxuICAgIH0pO1xuICB9XG59XG4iXX0=